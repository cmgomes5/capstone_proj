version: '3'

tasks:
  install-deps:
    desc: "Install Node.js dependencies for development"
    dir: virtual-dm
    cmd: npm install

  run-dev:
    desc: "Run the Next.js development server"
    deps: [install-deps]
    dir: virtual-dm
    cmd: npm run dev
    
  build:
    desc: "Build the Docker image for the Virtual DM application"
    cmd: docker build -t virtual-dm .
    
  docker-run:
    desc: "Build and run the Docker container"
    deps: [build]
    cmd: docker run -p 3000:3000 virtual-dm
    
  docker-run-ci:
    desc: "Build and run the Docker container in the background"
    deps: [build]
    cmd: docker run -d --name virtual-dm-app -p 3000:3000 --restart unless-stopped virtual-dm

  test:
    desc: "Run the complete Playwright test suite"
    deps: [install-deps]
    dir: virtual-dm
    cmds:
      - npx playwright install
      - npm run test

  tilt:
    env:
      KUBECONFIG: .kube/k3dconfig
    desc: Load Tilt Cluster with local build
    cmds:
      - cmd: mkdir -p .kube
      - cmd: |
          echo "Looking for virtual-dm cluster..."
          cluster=$(k3d cluster ls --no-headers virtual-dm 2> /dev/null | awk '{print $1}')
          if [[ "$cluster" && $cluster = "virtual-dm" ]]; then
            echo "virtual-dm cluster present"
            k3d kubeconfig merge -s virtual-dm -o .kube/k3dconfig --overwrite
          else
            echo "not present... creating virtual-dm cluster"
            k3d cluster create virtual-dm --registry-create virtual-dm-registry:0.0.0.0:5000 1> /dev/null
            k3d kubeconfig merge -s virtual-dm -o .kube/k3dconfig --overwrite
          fi
      - cmd: kubectl config use-context k3d-virtual-dm
      - tilt up